<style>
    body {
        background-color: rgb(0, 38, 41);
    }

    .v {
        display: flex;
        flex-direction: column;
    }

    .h {
        display: flex;
        flex-direction: row;
    }

    .center {
        justify-content: center;
    }

    .picker-side {
        padding: 20px;
    }

    .gap {
        width: 250px;
    }

    .rect_container {
        padding: 2px;
    }

    .rect {
        width: 70;
        height: 70;
        background-color: blueviolet;
        border-radius: 10%;
    }

    .title {
        color: beige;
        font-size: 400%;
        font-weight: bold;
        text-align: center;
        font-family: 'Courier New', Courier, monospace;
        padding-top: 10%;
    }

    .text {
        font-size: 120%;
        font-weight: bold;
        color: beige;
    }

    .text_box {
        width: 200px;
        color: beige;
        align-content: center;
        height: 50px;
    }

    .enter_text {
        font-size: 200%;
        color: rgb(0, 38, 41);
        background-color: beige;
    }

    .container {
        padding: 30px;
    }

    .grid {
        width: 600;
        height: 600;
        border-radius: 5px;
        overflow: hidden;
    }

    .row {
        height: 12.5%;
        display: flex;
        flex-direction: row;
    }

    .cell {
        height: 100%;
        width: 12.5%;
        outline-style: solid;
        outline-color: rgb(0, 38, 41);
        background-color: blueviolet;
    }

    .box {
        position: relative;
    }

    .v_numbers {
        display: flex;
        flex-direction: row;
        position: absolute;
        top: -40;
        width: 100%;
    }

    .v_number {
        color: beige;
        font-size: 150%;
        width: 12.5%;
        text-align: center;
    }

    .h_numbers {
        display: flex;
        flex-direction: column;
        position: absolute;
        left: -50;
        height: 100%;
    }

    .h_number {
        color: beige;
        font-size: 150%;
        height: 12.5%;
        text-align: end;
        align-content: center;
    }

    .editor {
        padding-top: 300px;
    }

    .explain_color {
        width: 70px;
        height: 60px;
        padding: 0px;
        border: none;
        border-radius: 5px;
        background-color: blueviolet;

        margin-top: 10px;
        margin-right: 5px;
        box-sizing: border-box;
    }

    .cell {
        transition: transform 0.2s, box-shadow 0.2s ease;
    }

    .cell:hover {
        transform: translateZ(5px);
        z-index: 1;
        box-shadow: 0 0 10px 5px;
    }

    .cell.hold {
        transform: translateZ(5px);
        z-index: 1;
        box-shadow: 0 0 10px 5px;
        border: solid beige;
    }

    .color_picker:hover {
        box-shadow: 0 0 30px 10px beige;
        transform: translateZ(5px);
    }

    .explain_color.hold {
        box-shadow: 0 0 20px 5px beige;
        border: solid beige;
    }

    .explain_color.hold:hover {
        filter: brightness(80%);
    }

    .picker {
        display: none;
        width: 100px;
        height: 100px;
        background-color: aqua;
    }

    .table_column {
        padding-top: 300px;
        padding-right: 2%;
    }

    .table_box {
        overflow: scroll;
        max-height: 600px;
    }

    .table_box::-webkit-scrollbar {
        display: none;
    }

    th,
    td {
        padding: 10px;
        text-align: center;
    }

    th {
        position: sticky;
        top: 0;
        background-color: rgb(0, 38, 41);
        border: 1px solid beige;
        z-index: 2;
    }

    table,
    td {
        border: 1px solid beige;
        border-collapse: separate;
        border-spacing: 0;
        color: beige;
    }

    #download {
        padding: 10px;
        font-size: 150%;
        margin-top: 50px;
        background-color: beige;
        border: none;
        border-radius: 10%;
        color: rgb(0, 38, 41);
    }

    #download:hover {
        background-color: rgb(0, 38, 41);
        border: none;
        border-radius: 10%;
        color: beige;
        border: solid beige;
    }

    .dialog_button {
        padding: 5px;
        margin-top: 10px;
        margin-left: 20px;
        font-size: 150%;
        border: solid beige;
        color: rgb(0, 38, 41);
        border-radius: 10px;
    }

    .dialog_button:hover {
        color: beige;
        background-color: rgb(0, 38, 41);
    }

    .dialog {
        background-color: rgb(0, 38, 41);
        border: solid beige;
        border-radius: 20px;
    }

    .github-link {
        position: absolute;
        bottom: 2%;
        right: 2%;
        color: beige;
        font-size: 20px;
        font-weight: bold;
    }
</style>

<body>

    <div class="h center">

        <input type="color" id="picker" class="picker" />

        <a class="github-link" href="https://github.com/Simcha-Levine/ben_scipher" target="_blank">view source code</a>


        <div class="table_column">
            <div class="table_box">
                <table id="table">
                    <tr class="head">
                        <th>character</th>
                        <th>decimal</th>
                        <th>binary</th>
                        <th>hex</th>
                    </tr>
                </table>
            </div>

        </div>


        <div class="v" id="result">
            <div class="h center" id="key">
                <div class="picker-side">
                    <div class="text">horizontal</div>
                    <div class="text">0</div>
                    <div class="h">
                        <div class="rect_container">
                            <div class="rect color color_picker" data-color-type="0" id="both0"></div>
                        </div>
                        <div class="rect_container">
                            <div class="rect color color_picker" data-color-type="1" id="h0v1"></div>
                        </div>
                    </div>
                    <div class="text">1</div>
                    <div class="h">
                        <div class="rect_container">
                            <div class="rect color color_picker" data-color-type="11" id="both1"></div>
                        </div>
                        <div class="rect_container">
                            <div class="rect color color_picker" data-color-type="10" id="h1v0"></div>
                        </div>
                    </div>
                </div>

                <div class="gap">
                    <h1 class="title" id="title">ben cipher</h1>
                </div>

                <div class="picker-side">
                    <div class="text">vertical</div>
                    <div class="text">0</div>
                    <div class="h">
                        <div class="rect_container">
                            <div class="rect color color_picker" data-color-type="0" id="both0"></div>
                        </div>
                        <div class="rect_container">
                            <div class="rect color color_picker" data-color-type="10" id="h1v0"></div>
                        </div>
                    </div>
                    <div class="text">1</div>
                    <div class="h">
                        <div class="rect_container">
                            <div class="rect color color_picker" data-color-type="11" id="both1"></div>
                        </div>
                        <div class="rect_container">
                            <div class="rect color color_picker" data-color-type="1" id="h0v1"></div>
                        </div>
                    </div>
                </div>

            </div>

            <div class="container">
                <div class="box">
                    <div class="v_numbers">
                        <div class="v_number">128</div>
                        <div class="v_number">64</div>
                        <div class="v_number">32</div>
                        <div class="v_number">16</div>
                        <div class="v_number">8</div>
                        <div class="v_number">4</div>
                        <div class="v_number">2</div>
                        <div class="v_number">1</div>
                    </div>
                    <div class="h_numbers">
                        <div class="h_number">128</div>
                        <div class="h_number">64</div>
                        <div class="h_number">32</div>
                        <div class="h_number">16</div>
                        <div class="h_number">8</div>
                        <div class="h_number">4</div>
                        <div class="h_number">2</div>
                        <div class="h_number">1</div>
                    </div>
                    <div class="grid" id="grid">
                        <div class="row">
                            <div class="cell color" data-color-type="0"></div>
                            <div class="cell color" data-color-type="0"></div>
                            <div class="cell color" data-color-type="0"></div>
                            <div class="cell color" data-color-type="0"></div>
                            <div class="cell color" data-color-type="0"></div>
                            <div class="cell color" data-color-type="0"></div>
                            <div class="cell color" data-color-type="0"></div>
                            <div class="cell color" data-color-type="0"></div>
                        </div>
                        <div class="row">
                            <div class="cell color" data-color-type="0"></div>
                            <div class="cell color" data-color-type="0"></div>
                            <div class="cell color" data-color-type="0"></div>
                            <div class="cell color" data-color-type="0"></div>
                            <div class="cell color" data-color-type="0"></div>
                            <div class="cell color" data-color-type="0"></div>
                            <div class="cell color" data-color-type="0"></div>
                            <div class="cell color" data-color-type="0"></div>
                        </div>
                        <div class="row">
                            <div class="cell color" data-color-type="0"></div>
                            <div class="cell color" data-color-type="0"></div>
                            <div class="cell color" data-color-type="0"></div>
                            <div class="cell color" data-color-type="0"></div>
                            <div class="cell color" data-color-type="0"></div>
                            <div class="cell color" data-color-type="0"></div>
                            <div class="cell color" data-color-type="0"></div>
                            <div class="cell color" data-color-type="0"></div>
                        </div>
                        <div class="row">
                            <div class="cell color" data-color-type="0"></div>
                            <div class="cell color" data-color-type="0"></div>
                            <div class="cell color" data-color-type="0"></div>
                            <div class="cell color" data-color-type="0"></div>
                            <div class="cell color" data-color-type="0"></div>
                            <div class="cell color" data-color-type="0"></div>
                            <div class="cell color" data-color-type="0"></div>
                            <div class="cell color" data-color-type="0"></div>
                        </div>
                        <div class="row">
                            <div class="cell color" data-color-type="0"></div>
                            <div class="cell color" data-color-type="0"></div>
                            <div class="cell color" data-color-type="0"></div>
                            <div class="cell color" data-color-type="0"></div>
                            <div class="cell color" data-color-type="0"></div>
                            <div class="cell color" data-color-type="0"></div>
                            <div class="cell color" data-color-type="0"></div>
                            <div class="cell color" data-color-type="0"></div>
                        </div>
                        <div class="row">
                            <div class="cell color" data-color-type="0"></div>
                            <div class="cell color" data-color-type="0"></div>
                            <div class="cell color" data-color-type="0"></div>
                            <div class="cell color" data-color-type="0"></div>
                            <div class="cell color" data-color-type="0"></div>
                            <div class="cell color" data-color-type="0"></div>
                            <div class="cell color" data-color-type="0"></div>
                            <div class="cell color" data-color-type="0"></div>
                        </div>
                        <div class="row">
                            <div class="cell color" data-color-type="0"></div>
                            <div class="cell color" data-color-type="0"></div>
                            <div class="cell color" data-color-type="0"></div>
                            <div class="cell color" data-color-type="0"></div>
                            <div class="cell color" data-color-type="0"></div>
                            <div class="cell color" data-color-type="0"></div>
                            <div class="cell color" data-color-type="0"></div>
                            <div class="cell color" data-color-type="0"></div>
                        </div>
                        <div class="row">
                            <div class="cell color" data-color-type="0"></div>
                            <div class="cell color" data-color-type="0"></div>
                            <div class="cell color" data-color-type="0"></div>
                            <div class="cell color" data-color-type="0"></div>
                            <div class="cell color" data-color-type="0"></div>
                            <div class="cell color" data-color-type="0"></div>
                            <div class="cell color" data-color-type="0"></div>
                            <div class="cell color" data-color-type="0"></div>
                        </div>
                        <div class="row">
                            <div class="cell color" data-color-type="0"></div>
                            <div class="cell color" data-color-type="0"></div>
                            <div class="cell color" data-color-type="0"></div>
                            <div class="cell color" data-color-type="0"></div>
                            <div class="cell color" data-color-type="0"></div>
                            <div class="cell color" data-color-type="0"></div>
                            <div class="cell color" data-color-type="0"></div>
                            <div class="cell color" data-color-type="0"></div>
                        </div>







                    </div>
                </div>

            </div>
        </div>

        <div class="v editor" id="editor">
            <div class="text_box" id="letters_left">
                you need to use exactly 16 characters!
            </div>
            <textarea class="enter_text" name="text" id="text" rows="5" cols="10"></textarea>

            <div class="h">
                <div class="color_box">
                    <div class="explain_color color color_picker" data-color-type="0" id="explain_00"></div>
                </div>
                <div class="text_box">both vertical and horizontal are 0</div>
            </div>

            <div class="h">
                <div class="color_box">
                    <div class="explain_color color color_picker" data-color-type="11" id="explain_11"></div>
                </div>
                <div class="text_box">both vertical and horizontal are 1</div>
            </div>

            <div class="h">
                <div class="color_box">
                    <div class="explain_color color color_picker" data-color-type="1" id="explain_01"></div>
                </div>
                <div class="text_box">horizontal is 0 and vertical is 1</div>
            </div>

            <div class="h">
                <div class="color_box">
                    <div class="explain_color color color_picker" data-color-type="10" id="explain_10"></div>
                </div>
                <div class="text_box">horizontal is 1 and vertical is 0</div>
            </div>

            <div class="button_box">
                <button id="download">
                    download
                </button>

                <dialog id="dialog" class="dialog">
                    <div class="text" id="preview_text">preview: </div>
                    <div id="preview"></div>
                    <button class="dialog_button" id='close'>close</button>
                    <button class="dialog_button" id='proceed'>download</button>
                </dialog>

            </div>

        </div>
    </div>



</body>

<script>
    function setMapCookie(name, map) {
        const jsonString = JSON.stringify(Object.fromEntries(map));
        let expires = "";
        const date = new Date();
        date.setTime(date.getTime() + 7 * 24 * 60 * 60 * 1000);
        expires = "; expires=" + date.toUTCString();
        document.cookie = `${name}=${encodeURIComponent(jsonString)}${expires}; path=/; SameSite=Lax`;
    }

    function getMapFromCookie(name) {
        const cookies = document.cookie.split("; ");
        const cookie = cookies.find(row => row.startsWith(name + "="));
        if (cookie) {
            const value = decodeURIComponent(cookie.split("=")[1]);
            const parsedObject = JSON.parse(value);

            return new Map(
                Object.entries(parsedObject).map(([key, val]) => [isNaN(key) ? key : parseInt(key, 10), val])
            );
        }
        return new Map();
    }

    function setStringCookie(name, value) {
        let expires = "";
        const date = new Date();
        date.setTime(date.getTime() + 7 * 24 * 60 * 60 * 1000)
        expires = `; expires=${date.toUTCString()}`;
        document.cookie = `${name}=${encodeURIComponent(value)}${expires}; path=/; SameSite=Lax`;
    }

    function getStringCookie(name) {
        const cookies = document.cookie.split("; ");
        const cookie = cookies.find(row => row.startsWith(name + "="));
        if (cookie) {
            return decodeURIComponent(cookie.split("=")[1]);
        }
        return ""
    }

    function svg(content, width, height) {
        return `
    <svg width="${width}" height="${height}"  
    xmlns:sodipodi="http://sodipodi.sourceforge.net/DTD/sodipodi-0.dtd"
    xmlns="http://www.w3.org/2000/svg">${content}
    </svg>`
    }


    function rect(color, stroke, stroke_width, id, width, height, x, y) {
        return `
      <rect
        style="fill:${color};stroke:${stroke};stroke-width:${stroke_width};"
        id="rect${id}"
        width="${width}%"
        height="${height}%"
        x="${x}%"
        y="${y}%" />`
    }

    function grid(size, color_map, stroke, stroke_width, cipher_grid) {
        let grid = ""
        let percentage = 1 / size * 100
        let i = 0
        for (let x = 0; x < size; x++) {
            for (let y = 0; y < size; y++) {
                grid += rect(
                    color_map.get(cipher_grid[y][x]),
                    stroke, stroke_width,
                    i++,
                    percentage, percentage,
                    x * percentage, y * percentage)
            }
        }

        return grid
    }

    function create_svg(color_map, cipher_grid) {
        return svg(
            grid(8, color_map, 'rgb(0, 38, 41)', 2.5, cipher_grid)
            + rect('#00000000', 'rgb(0, 38, 41)',
                5,
                'Frame',
                100, 100,
                0, 0),
            500, 500)
    }

    function get_cell(cells, x, y) {
        return cells[x + y * size]
    }

    function update_text(text) {
        document.getElementById('text').value = text
        setStringCookie('text', text)
    }

    function get_grid(text) {

        let left = 16 - text.length
        if (left > 0) {
            text = text + '\0'.repeat(left)
        }

        let grid = []

        let i = 0
        for (let y = 0; y < 8; y++) {
            let letter_bin = text.charCodeAt(i++).toString(2).padStart(8, '0')
            let row = []
            for (let x = 0; x < 8; x++) {
                if (letter_bin[x] == '0') {
                    row.push(0)
                } else {
                    row.push(10)
                }
            }
            grid.push(row)
        }

        for (let x = 0; x < 8; x++) {
            let letter_bin = text.charCodeAt(i++).toString(2).padStart(8, '0')
            for (let y = 0; y < 8; y++) {
                if (letter_bin[y] == '1') {
                    grid[y][x] += 1
                }
            }
        }

        return grid
    }

    function fill_grid(cells, text, color_map) {
        let grid = get_grid(text)

        for (let y = 0; y < 8; y++) {
            for (let x = 0; x < 8; x++) {

                get_cell(cells, x, y).dataset.colorType = grid[y][x]
            }
        }
        update_colors()
    }

    function unravel_grid(cells) {
        let i = 0
        let text = ""
        for (let y = 0; y < 8; y++) {
            let letter = ""
            for (let x = 0; x < 8; x++) {
                letter += Math.floor(parseInt(get_cell(cells, x, y).dataset.colorType, 10) / 10)
            }
            text += String.fromCharCode(parseInt(letter, 2))
        }

        for (let x = 0; x < 8; x++) {
            let letter = ""
            for (let y = 0; y < 8; y++) {
                letter += parseInt(get_cell(cells, x, y).dataset.colorType, 10) % 10
            }
            text += String.fromCharCode(parseInt(letter, 2))
        }

        return text
    }

    function make_row(char, dec, bin, hex) {
        return `
            <tr>
                <td>${char}</td>
                <td>${dec}</td>
                <td>${bin}</td>
                <td>${hex}</td>
            </tr>`
    }

    function generate_ascii_table() {
        let table = document.getElementById("table")

        for (let i = 33; i < 127; i++) {
            const char = String.fromCharCode(i)
            const decimal = i
            const binary = i.toString(2).padStart(8, '0');
            const hex = i.toString(16).toUpperCase()

            table.innerHTML += make_row(char, decimal, binary, hex)
        }
    }

    function update_colors() {
        document.querySelectorAll(`.color`).forEach((element) => {
            element.style.background = color_map.get(parseInt(element.dataset.colorType, 10))
        })
    }

    function downloadString(text, fileType, fileName) {
        var blob = new Blob([text], { type: fileType });

        var a = document.createElement('a');
        a.download = fileName;
        a.href = URL.createObjectURL(blob);
        a.dataset.downloadurl = [fileType, a.download, a.href].join(':');
        a.style.display = "none";
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        setTimeout(function () { URL.revokeObjectURL(a.href); }, 1500);
    }

    function setup_download_dialog() {

        document.getElementById('download').addEventListener('click', (e) => {
            const name = document.getElementById('text').value
            document.getElementById('dialog').showModal()
            document.getElementById('preview').innerHTML = create_svg(color_map, get_grid(text_area.value))
            document.getElementById('preview_text').innerText = `'${name}.svg'`

        })

        document.getElementById('close').addEventListener('click', (e) => {
            document.getElementById('dialog').close()
        })

        document.getElementById('proceed').addEventListener('click', (e) => {
            const name = document.getElementById('text').value
            downloadString(create_svg(color_map, get_grid(text_area.value)), 'svg', `${name}.svg`)
            document.getElementById('dialog').close()
        })
    }

    function reset_holds() {
        last_cell.classList.remove('hold')
        document.getElementById('explain_00').classList.remove('hold')
        document.getElementById('explain_11').classList.remove('hold')
        document.getElementById('explain_01').classList.remove('hold')
        document.getElementById('explain_10').classList.remove('hold')
        last_cell = null
    }

    let last_color = 0
    let last_cell = null
    function setup_color_listeners() {

        document.getElementById('picker').addEventListener('change', (event) => {
            color_map.set(last_color, event.target.value)

            update_colors()
            setMapCookie('color_map', color_map, 7)

        })

        window.addEventListener('click', (event) => {


            if (last_cell != null) {
                if (event.target.classList.contains('explain_color')) {
                    last_cell.dataset.colorType = event.target.dataset.colorType
                    update_colors()
                    update_text(unravel_grid(cells))
                }
                reset_holds()
            }
            else if (event.target.classList.contains('color_picker')) {

                document.getElementById(`picker`).showPicker()
                last_color = parseInt(event.target.dataset.colorType, 10)
            }
            else if (event.target.classList.contains('cell')) {
                last_cell = event.target;
                last_cell.classList.add('hold')
                document.getElementById('explain_00').classList.add('hold')
                document.getElementById('explain_11').classList.add('hold')
                document.getElementById('explain_01').classList.add('hold')
                document.getElementById('explain_10').classList.add('hold')
            }
        })
    }

    let size = 8
    let percentage = 1 / size * 100

    let cells = document.querySelectorAll(".cell")
    let text_area = document.getElementById('text')
    let letters_left = document.getElementById('letters_left')
    let original_text = letters_left.innerText


    let color_map = getMapFromCookie('color_map')
    if (color_map.size == 0) {
        console.log("once and no more")
        color_map.set(0, '#ed333b')
        color_map.set(11, '#3584e4')
        color_map.set(1, '#2ec27e')
        color_map.set(10, '#813d9c')
    }

    update_text(getStringCookie('text'))

    text_area.addEventListener('input', (e) => {
        if (text_area.value.length == 0) {
            letters_left.innerText = original_text
        } else {
            letters_left.innerText = `you have ${16 - text_area.value.length} left`
        }

        fill_grid(cells, text_area.value, color_map)
        setStringCookie('text', text_area.value)
    })

    document.getElementById('title').addEventListener('mouseover', (e) => {
        e.target.innerText = 'bill cipher'

        setTimeout(() => {
            e.target.innerText = "ben cipher";
        }, 200);
    })

    setup_color_listeners()
    setup_download_dialog()
    generate_ascii_table()
    fill_grid(cells, text_area.value, color_map)
</script>